from fastapi import APIRouter
 
from langchain_core.messages import HumanMessage,AIMessage
from langchain_core.prompts import (FewShotChatMessagePromptTemplate,
                                    ChatPromptTemplate,
                                    AIMessagePromptTemplate,
                                    HumanMessagePromptTemplate,
                                    SystemMessagePromptTemplate,
                                    MessagesPlaceholder)
from app.core.config import settings
from langchain_openai import ChatOpenAI


api_lc_fscpt_mp = APIRouter()


@api_lc_fscpt_mp.get("/")
async def default():
    return {"response": "Hello from api_lc_fscpt_mp"}


@api_lc_fscpt_mp.get("/few_shot_chat_pt_mp")
async def fewshot_prompt(qution:str="What is a PPO plan?", context: str="PPO allows members to visit out-of-network providers."):
    try:
        response = invoke_llm(qution, context)
        return response
    except Exception as e:
        return {"error": str(e)}

def invoke_llm(request: str, context: str):
    llm = get_llm()
    prompt = get_prompt()
    chat_history = get_chat_history()
    final_prompt =  prompt.format_messages(
        question = request,
        context = context,
        max_words = 50,
        chat_history = chat_history
    )
    response = llm.invoke(final_prompt)
    # Add logic to invoke the LLM with the prompt here
    return response

def get_llm():
    llm = ChatOpenAI(model_name=get_model_name(), temperature=0,
                     openai_api_key=get_open_ai_key())
    return llm

def get_model_name():
    return settings.open_ai_model_name

def get_open_ai_key():
    return settings.open_ai_key

def get_prompt():
    few_shot_examples = few_shot_messages()
    prompt = ChatPromptTemplate.from_messages(
        SystemMessagePromptTemplate.from_template(
            "You are an insurance domain expert specializing in UB claims."
        ),
        few_shot_examples,
        MessagesPlaceholder(variable_name="chat_history"),
        HumanMessagePromptTemplate.from_template("Question: {question}\nContext: {context}\nLimit to {max_words} words.")
     )
    return prompt

def get_examples():
    examples = [
            {
                "question": "What is UB claim?",
                "answer": "A UB claim is a hospital billing claim using the Uniform Billing format."
            },
            {
                "question": "What is EOB?",
                "answer": "EOB stands for Explanation of Benefits issued by insurers."
            }
            ]
    return examples

def get_chat_prompt_template():
    example_prompt = ChatPromptTemplate.from_messages([
        HumanMessagePromptTemplate.from_template("Question: {question}"),
        AIMessagePromptTemplate.from_template("Answer: {answer}")
    ])
    return example_prompt


def few_shot_messages():
    examples = get_examples()
    chat_pt = get_chat_prompt_template()
    few_shot_messages = FewShotChatMessagePromptTemplate(
        examples=examples,
        example_prompt=chat_pt
    )
    return few_shot_messages
 

def get_chat_history():
    chat_history=[
            HumanMessage(content="What is health insurance?"),
            AIMessage(content="Health insurance covers medical expenses."),
            HumanMessage(content="My names is Sitha"),
            AIMessage(content="Hi Sitha, nice to hear from you")
        ]
    return chat_history